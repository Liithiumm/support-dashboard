<!doctype html>
<html lang="fr" class="noadmin">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Support • Neon Glass PRO — Sheets Overlay</title>
<base href="/support-dashboard/">
  
  <!-- CSP (inchangée pour compat avec inline). Idéalement: passer à une CSP par nonce plus tard. -->
  <meta http-equiv="Content-Security-Policy"
        content="
    default-src 'self';
    script-src 'self' https://www.gstatic.com https://apis.google.com 'unsafe-inline';
    connect-src 'self'
      https://firestore.googleapis.com
      https://www.googleapis.com
      https://www.gstatic.com
      https://identitytoolkit.googleapis.com
      https://securetoken.googleapis.com;
    img-src 'self' data: blob:;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com;
    frame-src https://accounts.google.com;
    frame-ancestors 'none';
    base-uri 'self';
    form-action 'self';
  ">

  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;600&display=swap" rel="stylesheet">

  <script>
    // Masque dur au tout début (anti-flash)
    document.documentElement.classList.add('noadmin');
    document.documentElement.classList.remove('auth');

    // Redirect sûr vers la page de login du dossier courant
    function goToLoginWithRedirect(targetPath) {
      try {
        const login = new URL("index.html", location.href); // même origine
        const back  = targetPath || (location.pathname + location.search + location.hash);
        const url   = new URL(back, location.origin);
        // On n'autorise que le même origin → anti open-redirect
        const safe  = (url.origin === location.origin)
          ? (url.pathname + url.search + url.hash)
          : "app.html";
        login.searchParams.set("redirect", safe);
        location.replace(login.toString());
      } catch {
        location.replace("index.html");
      }
    }

    // Ancien garde-fou basé sur sessionStorage → on garde le flow, mais on utilise la redirection sûre
    (function(){
      try{
        const ok = sessionStorage.getItem("is_admin_v2") === "1";
        if (!ok) goToLoginWithRedirect();
      }catch(e){
        goToLoginWithRedirect();
      }
    })();
  </script>

  <style>
    /* === Styles existants (inchangés) === */
    :root{
      --bg0:#050a12; --bg1:#0b1728;
      --ink:#eaf4ff; --muted:#9bb5cb; --muted-strong:#cfe4ff;
      --accent:#1ec8ff; --accent-2:#63ffd7;
      --panel-1: rgba(12,22,36,.52);
      --panel-2: rgba(10,20,34,.64);
      --border-outer: rgba(120,200,255,.28);
      --border-inner: rgba(255,255,255,.08);
      --radius:18px;
      --shadow-lg: 0 26px 64px rgba(0,0,0,.55);
      --shadow-md: 0 14px 36px rgba(0,0,0,.45);
      --shadow-sm: 0 6px 18px rgba(0,0,0,.38);
      --sheet-bg: rgba(10,18,30,.78);
      --sheet-blur: blur(12px) saturate(140%);
    }
    *,*::before,*::after{ box-sizing:border-box }
    html,body{ width:100%; height:100% }
    html{ background:var(--bg0) }
    body{
      margin:0; color:var(--ink);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      background:
        radial-gradient(1200px 520px at 28% -8%, rgba(30,200,255,.18), transparent 60%),
        radial-gradient(1100px 480px at 120% -20%, rgba(99,255,215,.12), transparent 65%),
        linear-gradient(180deg, #050a12 0%, #0b1728 48%, #06101a 100%);
    }
    .noadmin .app{ filter: blur(10px) saturate(115%); pointer-events:none; user-select:none }
    .auth .app{ filter:none; pointer-events:auto }
    #privacyMask{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999; background:rgba(2,6,23,.35); backdrop-filter: blur(10px) saturate(120%); -webkit-backdrop-filter: blur(10px) saturate(120%); }
    #privacyMask.show{ display:flex; }
    #privacyMask .mask-card{ padding:18px 22px; border-radius:16px; background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.12); box-shadow:0 10px 30px rgba(0,0,0,.45); color:#e6f0ff; text-align:center; font-weight:700; }
    #privacyMask .mask-note{ opacity:.85; font-weight:500; font-size:12px; margin-top:8px; }
    #privacyMask .btn{ pointer-events:auto; }
    .app{ min-height:100dvh; display:grid; grid-template-rows:auto 1fr auto; }
    .header{ position: sticky; top:0; z-index:10; padding: 16px clamp(14px,4vw,22px);
      background: linear-gradient(180deg, rgba(6,12,20,.75), rgba(6,12,20,.35), transparent),
                  repeating-linear-gradient(90deg, rgba(255,255,255,.035) 0 1px, transparent 1px 3px);
      border-bottom:1px solid rgba(120,200,255,.18); backdrop-filter: blur(6px) saturate(120%); }
    .h-wrap{ max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:center; gap:12px; position:relative; }
    .h-dot{ width:10px; height:10px; border-radius:50%; background: radial-gradient(circle at 40% 30%, #fff, #9ee6ff 30%, rgba(158,230,255,0) 70%); box-shadow: 0 0 22px rgba(30,200,255,.8); }
    h1{ margin:0; font-size: clamp(18px, 2.2vw, 26px); letter-spacing:.3px; text-shadow:0 0 18px rgba(30,200,255,.35) }
    .container{ width:100%; max-width:min(1100px, 94vw); margin:0 auto; padding: 14px clamp(14px,4vw,22px) 90px; }
    .card{ position:relative; overflow:hidden; border-radius: var(--radius); background: linear-gradient(180deg, var(--panel-1), var(--panel-2));
      border:1px solid var(--border-outer); box-shadow: var(--shadow-lg); padding:16px; }
    .card::before{ content:""; position:absolute; inset:0; pointer-events:none; border-radius:inherit; box-shadow: inset 0 0 0 1px var(--border-inner), inset 0 1px 24px rgba(30,200,255,.08); }
    .card::after{ content:""; position:absolute; left:0; right:0; top:0; height:46%; background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,0) 60%); pointer-events:none; }
    .noise{ position:absolute; inset:0; pointer-events:none; border-radius:inherit; opacity:.08; mix-blend-mode: overlay;
      background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='2' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0'/></filter><rect width='100%' height='100%' filter='url(%23n)' opacity='.35'/></svg>"); }
    input, select, textarea{ width:100%; border-radius:12px; background: rgba(7,16,26,.82); border:1px solid #1f3a56; color:var(--ink); padding:10px 12px; box-shadow: inset 0 1px 0 rgba(255,255,255,.05); }
    textarea{ min-height:70px }
    input:focus, select:focus, textarea:focus{ outline:none; border-color:#2a79a6; box-shadow:0 0 0 2px rgba(30,200,255,.22) }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 16px; border-radius:999px; border:0; cursor:pointer; font-weight:800; line-height:1; color:#03121a; background: linear-gradient(180deg, #b9efff, #59d4ff); box-shadow: inset 0 1px 0 rgba(255,255,255,.65), 0 6px 18px rgba(0,0,0,.38); }
    .btn.gray{ background:#2b3446; color:#eaf4ff; box-shadow: inset 0 0 0 1px rgba(255,255,255,.14), 0 6px 18px rgba(0,0,0,.38); }
    .btn.small{ padding:8px 12px; font-size:13px }
    .actions{ display:flex; gap:8px; flex-wrap:wrap }
    a.btn{ text-decoration:none }
    .member-ro{ display:grid; grid-template-columns: 1fr auto auto; gap:8px; border:1px solid rgba(120,200,255,.28); border-radius:12px; padding:10px; background: linear-gradient(180deg, rgba(16,28,44,.58), rgba(10,20,34,.62)); box-shadow: 0 6px 18px rgba(0,0,0,.38); align-items:center; margin-bottom:8px; }
    .member-ro .tag{ font-weight:900; letter-spacing:.2px }
    .member-ro .role{ color:var(--muted-strong); font-size:clamp(12px, 1.2vw, 13px) }
    .member-ro .tickets-badge{ min-width:56px; text-align:center; font-weight:900; border-radius:999px; padding:6px 10px; background:linear-gradient(90deg, #e7f5ff, #cfe9ff, #e7f5ff); color:#0c1a2a; border:1px solid rgba(120,200,255,.45); box-shadow: inset 0 1px 0 rgba(255,255,255,.7); background-size:200% 100%; animation: badgeGlow 3.2s linear infinite; }
    @keyframes badgeGlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .member-ro .status{ min-width:66px; text-align:center; font-weight:900 }
    .status.ok{ color:#24e3b5 } .status.low{ color:#ff9c9c } .status.neutral{ color:#8eb5cf }
    .tabbar{ position:fixed; bottom:0; left:0; right:0; z-index:40; padding:10px 12px calc(10px + env(safe-area-inset-bottom)); background: linear-gradient(180deg, rgba(6,12,20,.15), rgba(6,12,20,.7)); border-top:1px solid rgba(120,200,255,.2); backdrop-filter: blur(8px) saturate(120%); }
    .tabs{ max-width:1000px; margin:0 auto; display:flex; justify-content:center; align-items:center; gap:12px; width:fit-content }
    .tab{ min-width:120px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; padding:10px 8px; border-radius:12px; cursor:pointer; color:#cfe9ff; font-size:12px; background: linear-gradient(180deg, rgba(14,24,38,.35), rgba(10,20,34,.5)); border:1px solid rgba(120,200,255,.26); box-shadow: 0 6px 18px rgba(0,0,0,.38); transition: filter .12s, transform .18s cubic-bezier(.2,.8,.2,1), box-shadow .15s; text-align:center }
    .tab.active{ filter:brightness(1.08); box-shadow: var(--shadow-md); transform: translateY(-2px) }
    .tab .ic{ font-size:18px }
    .backdrop{ position:fixed; inset:0; z-index:30; display:none; background: radial-gradient(1200px 600px at 50% -10%, rgba(30,200,255,.10), transparent 60%), linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.65)); transition: opacity .22s; opacity:0 }
    .backdrop.show{ display:block; opacity:1 }
    .sheet{ position:fixed; inset:0; z-index:50; transform:translateY(100%); transition: transform .55s cubic-bezier(.18,.88,.18,1); will-change: transform; display:block }
    .sheet.open{ transform:translateY(0) }
    .sheet .sheet-inner{ height:100dvh; margin:0 auto; max-width:1000px; background:var(--sheet-bg); backdrop-filter:var(--sheet-blur); border:1px solid rgba(120,200,255,.22); border-radius:0; box-shadow:none; padding:14px; overflow:auto }
    .sheet .handle{ width:54px; height:5px; border-radius:999px; margin:6px auto 12px; background: linear-gradient(180deg, #cfe9ff, #9bd4ff); box-shadow: inset 0 1px 0 rgba(255,255,255,.8) }
    @media (min-width:900px){
      .sheet .sheet-inner{ height:min(86dvh,720px); max-width:920px; margin:6dvh auto; border-radius:20px; box-shadow:0 30px 80px rgba(0,0,0,.55) }
      .sheet .handle{ display:none }
      .tab{ min-width:140px }
    }
    @media (max-width:480px){ .actions{ justify-content:center !important; width:100% } .actions .btn{ flex:1 1 auto; min-width:44% } .tabs{ width:100%; justify-content: space-around } .tab{ min-width:90px; padding:10px 6px } }
    @media (max-width:380px){ .actions .btn{ min-width:46% } .tab{ min-width:86px } }
    @media (max-width:600px){
      #sheet-edit .actions[style*="justify-content:space-between"], #sheet-gen .actions, #sheet-links .actions{ justify-content:center !important; gap:10px !important; flex-wrap:wrap }
    }
    .locked [data-admin]{pointer-events:none;opacity:.6;filter:grayscale(.2)}
  </style>
</head>
<body>

  <!-- Masque flou + CTA login -->
  <div id="privacyMask" aria-hidden="true">
    <div class="mask-card">
      <div data-i18n="mask_message">🔒 Contenu verrouillé — veuillez vous connecter pour afficher et modifier les données.</div>
      <div style="margin-top:10px">
        <button id="loginBtnMask" class="btn small" data-i18n="admin_login">Se connecter</button>
      </div>
      <div class="mask-note" data-i18n="mask_note">Vous devez être connecté(e) avec un email autorisé.</div>
    </div>
  </div>

  <div class="app">
    <header class="header">
      <div class="h-wrap">
        <span class="h-dot"></span>
        <div><h1>Tableau de support — Neon Glass PRO</h1></div>
      </div>
    </header>

    <main class="container">
      <section id="baseCard" class="card">
        <div id="captureArea" aria-live="polite">
          <div class="support-title" data-i18n="support_ticket">Support — Tickets</div>
          <div id="weekLabel" class="week-label">Semaine du … au …</div>
          <div class="noise"></div>
          <div id="roList"></div>
        </div>
        <div class="actions" style="margin-top:10px; justify-content:flex-end">
          <button class="btn gray" id="refreshBtn">Actualiser</button>
          <button class="btn" id="exportPngBtn" data-i18n="export_png_btn">Télécharger l'image (PNG)</button>
        </div>
        <div class="lang-row" style="display:flex; justify-content:flex-end; margin-top:10px;">
          <div class="lang-switch" aria-label="Langue" style="display:flex; gap:6px; align-items:center; background: rgba(10,20,34,.5); border:1px solid rgba(120,200,255,.25); border-radius:999px; padding:4px;">
            <button id="lang-fr" type="button" class="btn gray small">FR</button>
            <button id="lang-en" type="button" class="btn gray small">EN</button>
          </div>
        </div>
      </section>
    </main>

    <div id="backdrop" class="backdrop"></div>

    <!-- Sheets -->
    <section id="sheet-gen" class="sheet" aria-hidden="true">
      <div class="sheet-inner">
        <div class="handle"></div><button class="close-x btn gray small" type="button" data-close-sheet>✕</button>
        <h2 data-i18n="gen_title">Générateur</h2>
        <div class="section-sub" data-i18n="gen_desc">Entre une semaine <b>lundi → dimanche</b>. La commande produira <code>après:</code> = (début − 1 jour) et <code>avant:</code> = (fin + 1 jour).</div>
        <div class="grid grid-2">
          <input id="dateFrom" type="date" data-i18n-attr="placeholder:gen_input_from_placeholder" placeholder="Début (lundi)">
          <input id="dateTo" type="date" data-i18n-attr="placeholder:gen_input_to_placeholder" placeholder="Fin (dimanche)">
        </div>
        <div class="actions" style="margin-top:10px">
          <button class="btn" id="genBtn" data-i18n="gen_generate_btn">Générer</button>
          <button class="btn gray" id="copyBtn" data-i18n="gen_copy_btn">Copier commande</button>
        </div>
        <textarea id="out" data-i18n-attr="placeholder:gen_result_placeholder" placeholder="Résultat…"></textarea>
      </div>
    </section>

    <section id="sheet-edit" class="sheet" aria-hidden="true">
      <div class="sheet-inner">
        <div class="handle"></div><button class="close-x btn gray small" type="button" data-close-sheet>✕</button>
        <div class="actions" style="justify-content:space-between; width:100%; display:flex; align-items:center;">
          <h2 style="margin:0" data-i18n="edit_title">Annuaire — Édition</h2>
          <div class="actions" style="gap:14px"><button class="btn" id="addBtn" data-i18n="add_member_btn">+ Ajouter un membre</button></div>
        </div>
        <div id="addForm" class="card" style="display:none; padding:10px; margin-top:10px">
          <div class="grid grid-2">
            <div><label data-i18n="add_form_tag">Tag Discord</label><input id="addTag" placeholder="ex: nouveau_membre" data-i18n-attr="placeholder:add_form_tag_ph"></div>
            <div><label data-i18n="add_form_role">Rôle</label>
              <select id="addRole">
                <option>Leader support</option><option>Senior support</option><option>Support</option><option>Trial support</option>
              </select>
            </div>
          </div>
          <div style="margin-top:8px"><label data-i18n="add_form_langs">Langues (abrév., ex: FR, ES, NL)</label><input id="addLangs" placeholder="ex: FR, ES" data-i18n-attr="placeholder:add_form_langs_ph"></div>
          <div class="actions" style="margin-top:8px"><button class="btn" id="confirmAddBtn" data-i18n="add_form_add">Ajouter</button><button class="btn gray" id="cancelAddBtn" data-i18n="add_form_cancel">Fermer</button></div>
        </div>
        <div id="membersContainer" style="margin-top:8px"></div>
      </div>
    </section>

    <section id="sheet-links" class="sheet" aria-hidden="true">
      <div class="sheet-inner">
        <div class="handle"></div><button class="close-x btn gray small" type="button" data-close-sheet>✕</button>
        <h2 data-i18n="links_title">Liens utiles</h2>
        <div id="linksList"></div>

        <div id="editorTickets" class="card" style="display:none; padding:10px; margin-top:10px">
          <h3 style="margin:0 0 6px 0; font-size:14px" data-i18n="new_url_for_tickets">Nouvelle URL pour “Tickets log”</h3>
          <input id="ticketsUrlInput">
          <div class="actions" style="margin-top:8px"><button class="btn" id="saveTicketsUrl" data-i18n="save_btn">Sauver</button><button class="btn gray" data-close="#editorTickets" data-i18n="cancel_btn">Annuler</button></div>
        </div>
        <div id="editorLeader" class="card" style="display:none; padding:10px; margin-top:10px">
          <h3 style="margin:0 0 6px 0; font-size:14px" data-i18n="new_url_for_leader">Nouvelle URL pour “Leader chat”</h3>
          <input id="leaderUrlInput">
          <div class="actions" style="margin-top:8px"><button class="btn" id="saveLeaderUrl" data-i18n="save_btn">Sauver</button><button class="btn gray" data-close="#editorLeader" data-i18n="cancel_btn">Annuler</button></div>
        </div>
        <div id="editorSheet" class="card" style="display:none; padding:10px; margin-top:10px">
          <h3 style="margin:0 0 6px 0; font-size:14px" data-i18n="new_url_for_sheet">Nouvelle URL pour “Google Sheet hebdo”</h3>
          <input id="sheetUrlInput">
          <div class="actions" style="margin-top:8px"><button class="btn" id="saveSheetUrl" data-i18n="save_btn">Sauver</button><button class="btn gray" data-close="#editorSheet" data-i18n="cancel_btn">Annuler</button></div>
        </div>
      </div>
    </section>

    <nav class="tabbar">
      <div class="admin-lock" id="adminLockBadge" title="Locked — sign in">🔒 <span data-i18n="locked_label">Verrouillé</span></div>
      <div class="tabs">
        <button class="tab" data-sheet="sheet-gen"><span class="ic">⚙️</span> <span data-i18n="tab_generator">Générateur</span></button>
        <button class="tab" data-sheet="sheet-edit"><span class="ic">✏️</span> <span data-i18n="tab_edit">Éditer</span></button>
        <button class="tab" data-sheet="sheet-links"><span class="ic">🔗</span> <span data-i18n="tab_links">Liens</span></button>
      </div>
      <div class="admin-cta">
        <button id="adminLogoutBtn" class="btn small" style="display:none">Déconnexion</button>
      </div>
    </nav>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Utils: lock UI + privacy mask -->
  <script>
    function isAdminNow(){
      try { return sessionStorage.getItem('is_admin_v2') === '1'; } catch { return false; }
    }
    function updatePrivacyMask(){
      const mask = document.getElementById('privacyMask');
      const admin = isAdminNow();
      if (mask) mask.classList.toggle('show', !admin);
      document.documentElement.classList.toggle('noadmin', !admin);
      document.documentElement.classList.toggle('auth', admin);
    }
    function applyLockUI(){
      const on = isAdminNow();
      document.body.classList.toggle('locked', !on);
      const badge = document.getElementById('adminLockBadge');
      const logout= document.getElementById('adminLogoutBtn');
      if(badge) badge.style.display = on ? 'none' : 'inline-flex';
      if(logout) logout.style.display= on ? 'inline-flex' : 'none';
      updatePrivacyMask();
    }
    document.addEventListener('DOMContentLoaded', updatePrivacyMask);
  </script>

  <!-- i18n, UI & logique locale (inchangés sauf sanitizer & login mask click) -->
  <script>
    const I18N = { /* … dictionnaires FR/EN inchangés … */ };
    // (par souci de place, je garde exactement ton contenu I18N et fonctions setLang/applyTranslations)

    // … (tes fonctions I18N / tabs / generator / export / members … inchangées) …

    // Sanitize d’URL pour l’affichage des liens
    function sanitizeUrl(u) {
      try { const url = new URL(u, location.origin);
        return /^(https?:)$/i.test(url.protocol) ? url.href : '#';
      } catch { return '#'; }
    }

    // Liens: seul changement → usage de sanitizeUrl(...) au rendu
    const DEFAULT_LINKS = {
      tickets: "https://discord.com/channels/1047415612495892480/1047415615616454661",
      leader:  "https://discord.com/channels/1047415612495892480/1047415615616454661",
      sheet:   "https://docs.google.com/spreadsheets/d/1f_NOkv3nh67LItsCEs7kL64QV9W1EH9oIR91PQzpmII/edit?usp=drivesdk"
    };
    function loadLinks(){
      try{
        const raw=localStorage.getItem('support_links_v92'); if(!raw) return {...DEFAULT_LINKS};
        const o=JSON.parse(raw)||{};
        return {tickets:o.tickets||DEFAULT_LINKS.tickets, leader:o.leader||DEFAULT_LINKS.leader, sheet:o.sheet||DEFAULT_LINKS.sheet};
      }catch{ return {...DEFAULT_LINKS}; }
    }
    let LINKS=loadLinks();
    function renderLinks(){
      const lang = (localStorage.getItem('ui_lang')||'fr');
      const box=document.getElementById('linksList'); box.innerHTML='';
      const rows=[
        {key:'tickets', label:(lang==='fr'?'Tickets log':'Tickets log'), editor:'#editorTickets', input:'#ticketsUrlInput'},
        {key:'leader',  label:(lang==='fr'?'Leader chat':'Leader chat'), editor:'#editorLeader',  input:'#leaderUrlInput'},
        {key:'sheet',   label:(lang==='fr'?'Google Sheet hebdo':'Weekly Google Sheet'), editor:'#editorSheet',   input:'#sheetUrlInput'}
      ];
      rows.forEach(r=>{
        const row=document.createElement('div'); row.className='link-row';
        row.style.display='flex'; row.style.flexDirection='column'; row.style.alignItems='center'; row.style.gap='12px'; row.style.textAlign='center'; row.style.padding='16px';
        const btnText = (lang==='fr'?'Accéder':'Go');
        const aria = (lang==='fr' ? 'Accéder ' : 'Go ') + r.label;
        row.innerHTML=`
          <div class="link-label"><b>${r.label}</b></div>
          <div class="link-actions">
            <a class="btn gray small" href="${sanitizeUrl(LINKS[r.key])}" target="_blank" rel="noopener noreferrer" aria-label="${aria}">${btnText}</a>
            <button class="btn small" data-edit="${r.editor}" data-input="${r.input}" data-key="${r.key}" aria-label="Edit ${r.label}">✎</button>
          </div>`;
        box.appendChild(row);
      });
      box.style.display='grid'; box.style.gap='20px'; box.style.justifyItems='center';
      box.querySelectorAll('button[data-edit]').forEach(b=>{
        b.onclick=function(){
          const key=this.getAttribute('data-key');
          const ed=document.querySelector(this.getAttribute('data-edit'));
          const input=document.querySelector(this.getAttribute('data-input'));
          input.value=LINKS[key]||'';
          document.querySelectorAll('#editorTickets,#editorLeader,#editorSheet').forEach(x=>x.style.display='none');
          ed.style.display='block'; input.focus();
        };
      });
    }
    renderLinks();

    // Bouton “Se connecter” du masque → redirection sûre
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('#loginBtnMask');
      if (!btn) return;
      goToLoginWithRedirect("app.html");
    });

    // (Le reste de ton JS UI: i18n, members, tickets, export PNG… reste identique)
  </script>

  <!-- Firestore realtime + App Check -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app-check.js";

    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyD0X6PY8Xwnt6GFjh4I9J2v65KBPnFPuEs",
      authDomain: "support-app-64fca.firebaseapp.com",
      projectId: "support-app-64fca",
      storageBucket: "support-app-64fca.appspot.com",
      messagingSenderId: "391759293249",
      appId: "1:391759293249:web:e06e61accd103c98a60fc0",
      measurementId: "G-PYE2M5LMNY"
    };

    // Init unique
    const app = getApps().length ? getApp() : initializeApp(FIREBASE_CONFIG);

    // App Check avec TA clé
    try {
      initializeAppCheck(app, {
        provider: new ReCaptchaV3Provider("6LfyINcrAAAAALHjNBMMm3hRplWVUx4_i-HSLrpL"),
        isTokenAutoRefreshEnabled: true,
      });
    } catch {}

    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Miroirs locaux (inchangés)
    window.LINKS = window.LINKS || {
      tickets: "https://discord.com/channels/1047415612495892480/1047415615616454661",
      leader:  "https://discord.com/channels/1047415612495892480/1047415615616454661",
      sheet:   "https://docs.google.com/spreadsheets/d/1f_NOkv3nh67LItsCEs7kL64QV9W1EH9oIR91PQzpmII/edit?usp=drivesdk"
    };
    window.members = window.members || [];
    window.tickets = window.tickets || {};
    window.supportWeek = window.supportWeek || { from:null, to:null };

    function lsGet(key, def){ try{ const v=localStorage.getItem(key); return v?JSON.parse(v):def; }catch{ return def; } }
    function lsSet(key,val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch{} }

    function useLocalFallback(){
      window.LINKS   = lsGet('support_links_v92', window.LINKS);
      window.members = lsGet('support_members_v90', window.members);
      window.tickets = lsGet('support_tickets_v91', window.tickets);
      try{ const f=localStorage.getItem('support_week_from'); const t=localStorage.getItem('support_week_to'); window.supportWeek = {from:f, to:t}; }catch{}
      try{ renderLinks(); }catch{}
      try{ renderMembers(); renderReadOnly(); }catch{}
      try{ const lang=(localStorage.getItem('ui_lang')||'fr'); updateWeekLabel(lang, window.supportWeek.from, window.supportWeek.to); }catch{}
    }

    async function ensureDocs(){
      await setDoc(doc(db, "links", "config"), window.LINKS, { merge:true });
      await setDoc(doc(db, "ui", "state"), { from: window.supportWeek.from || null, to: window.supportWeek.to || null }, { merge:true });
    }

    function startRealtime(){
      onSnapshot(doc(db, "links", "config"), (snap)=>{ if(snap.exists()){ window.LINKS = snap.data()||{}; try{ renderLinks(); }catch{} } });
      onSnapshot(collection(db, "members"), (qs)=>{ window.members = qs.docs.map(d=>({ id:d.id, ...d.data() })); try{ renderMembers(); renderReadOnly(); }catch{} });
      onSnapshot(collection(db, "tickets"), (qs)=>{ const map={}; qs.forEach(d=> map[d.id]=(d.data()?.count)||0 ); window.tickets=map; try{ renderReadOnly(); }catch{} });
      onSnapshot(doc(db, "ui", "state"), (snap)=>{ const lang=(localStorage.getItem('ui_lang')||'fr'); if(snap.exists()){ const {from,to}=snap.data(); window.supportWeek={from:from||null, to:to||null}; try{ updateWeekLabel(lang, from, to); }catch{} } });
    }

    // Écritures
    window.saveLinkFirestore = async (key, value)=>{
      if (!db) { const L={...window.LINKS, [key]: value}; lsSet('support_links_v92', L); window.LINKS=L; try{ renderLinks(); }catch{}; return; }
      await setDoc(doc(db, "links", "config"), { [key]: value }, { merge: true });
    };
    window.addMemberFirestore = async (tag, role, langs)=>{
      if (!db) { const arr=[...window.members,{tag,role,langs}]; lsSet('support_members_v90', arr); window.members=arr; renderMembers(); renderReadOnly(); return; }
      await addDoc(collection(db, "members"), { tag, role, langs });
    };
    window.updateMemberFirestore = async (id, fields)=>{
      if (!db){
        const keyTag = fields.oldTag ?? fields.tag;
        const i = window.members.findIndex(m => m.id === id || m.tag === keyTag);
        if (i >= 0){
          const next = { ...window.members[i], ...fields };
          delete next.oldTag;
          window.members[i] = next;
          lsSet('support_members_v90', window.members);
          renderMembers();
          renderReadOnly();
        }
        return;
      }
      if (!id){
        const keyTag = fields.oldTag ?? fields.tag;
        const m = window.members.find(m => m.tag === keyTag);
        if (!m) return;
        id = m.id;
      }
      const toSave = { ...fields };
      delete toSave.oldTag;
      await updateDoc(doc(db, "members", id), toSave);
    };
    window.deleteMemberFirestore = async (id)=>{
      if(!db){ const arr=window.members.filter(m=>m.id!==id); lsSet('support_members_v90', arr); window.members=arr; renderMembers(); renderReadOnly(); return; }
      await deleteDoc(doc(db, "members", id));
    };
    window.setTicketsFirestore = async (tag, n)=>{
      if(!db){ const map={ ...(window.tickets||{}), [tag]: n}; lsSet('support_tickets_v91', map); window.tickets=map; renderReadOnly(); return; }
      await setDoc(doc(db, "tickets", tag), { count: n }, { merge: true });
    };
    window.saveWeekFirestore = async (from, to)=>{
      if(!db){ try{ localStorage.setItem('support_week_from', from); localStorage.setItem('support_week_to', to); }catch{}; return; }
      await setDoc(doc(db, "ui", "state"), { from, to }, { merge: true });
    };

    function wireUI(){
      const saveTicketsUrl = document.getElementById('saveTicketsUrl');
      const saveLeaderUrl  = document.getElementById('saveLeaderUrl');
      const saveSheetUrl   = document.getElementById('saveSheetUrl');
      if(saveTicketsUrl) saveTicketsUrl.onclick = async ()=>{ const v=(document.getElementById('ticketsUrlInput').value||'').trim(); if(!v) return; await window.saveLinkFirestore('tickets', v); document.getElementById('editorTickets').style.display='none'; };
      if(saveLeaderUrl)  saveLeaderUrl.onclick  = async ()=>{ const v=(document.getElementById('leaderUrlInput').value||'').trim();  if(!v) return; await window.saveLinkFirestore('leader', v); document.getElementById('editorLeader').style.display='none'; };
      if(saveSheetUrl)   saveSheetUrl.onclick   = async ()=>{ const v=(document.getElementById('sheetUrlInput').value||'').trim();   if(!v) return; await window.saveLinkFirestore('sheet', v);   document.getElementById('editorSheet').style.display='none'; };

      // Bouton refresh local
      document.getElementById('refreshBtn')?.addEventListener('click', ()=>{
        try{ renderMembers(); renderReadOnly(); renderLinks(); }catch{}
      });
    }

    // Auth flow
    onAuthStateChanged(auth, (user)=>{
      if (user) {
        // Débloque l’UI
        try {
          sessionStorage.setItem('is_admin_v2','1');
          sessionStorage.setItem('is_admin','1');
          sessionStorage.setItem('admin_ok','1');
        } catch {}
        document.documentElement.classList.remove('noadmin');
        document.documentElement.classList.add('auth');
        applyLockUI?.();
        ensureDocs().then(()=>{ startRealtime(); wireUI(); });
      } else {
        // Pas connecté → fallback local (lecture LS) + masque
        useLocalFallback();
        applyLockUI?.();
        // on propose le login
      }
    });

    // Logout bouton → redirection sûre
    document.getElementById('adminLogoutBtn')?.addEventListener('click', async ()=>{
      try { await signOut(auth); } catch {}
      try {
        sessionStorage.removeItem('is_admin_v2');
        sessionStorage.removeItem('is_admin');
        sessionStorage.removeItem('admin_ok');
      } catch {}
      window.__adminEmailOK = false;
      goToLoginWithRedirect("app.html");
    });
  </script>

</body>
            </html>
