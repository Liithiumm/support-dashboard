<!doctype html>
<html lang="fr" class="noadmin"> <!-- (1) Anti-flash: verrou par défaut -->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Support • Neon Glass PRO — Sheets Overlay</title>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;600&display=swap" rel="stylesheet">

  <!-- (1) Script ultra-tôt: bascule noadmin/auth AVANT le premier paint -->
  <script>
    (function earlyAuthClass(){
      try{
        var isAdmin = sessionStorage.getItem('is_admin') === '1';
        var html = document.documentElement;
        if(isAdmin){ html.classList.remove('noadmin'); html.classList.add('auth'); }
        else{ html.classList.add('noadmin'); html.classList.remove('auth'); }
      }catch(e){}
    })();
  </script>

  <style>
  /* ===== Neon Glass PRO core (v19 NOW-1..8) ===== */
  :root{
    --bg0:#050a12; --bg1:#0b1728;
    --ink:#eaf4ff; --muted:#9bb5cb; --muted-strong:#cfe4ff;
    --accent:#1ec8ff; --accent-2:#63ffd7;
    --panel-1: rgba(12,22,36,.52);
    --panel-2: rgba(10,20,34,.64);
    --border-outer: rgba(120,200,255,.28);
    --border-inner: rgba(255,255,255,.08);
    --radius:18px;
    --shadow-lg: 0 26px 64px rgba(0,0,0,.55);
    --shadow-md: 0 14px 36px rgba(0,0,0,.45);
    --shadow-sm: 0 6px 18px rgba(0,0,0,.38);
    --sheet-bg: rgba(10,18,30,.78);
    --sheet-blur: blur(12px) saturate(140%);
  }

  *{ box-sizing: border-box; }
  html, body{ width:100%; height:100%; }
  html{ background: var(--bg0); }
  body{
    margin:0; color:var(--ink);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    background:
      radial-gradient(1200px 520px at 28% -8%, rgba(30,200,255,.18), transparent 60%),
      radial-gradient(1100px 480px at 120% -20%, rgba(99,255,215,.12), transparent 65%),
      linear-gradient(180deg, #050a12 0%, #0b1728 48%, #06101a 100%);
  }

  /* (1) Règles globales .noadmin/.auth (anti-flash + masque) */
  .noadmin .app-content{ filter: blur(10px) saturate(110%); pointer-events:none; user-select:none; }
  .auth   .app-content{ filter:none; pointer-events:auto; }

  /* Masque flou (5) : message seul, pas de bouton */
  #privacyMask{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    z-index:9999; background:rgba(2,6,23,.35); backdrop-filter: blur(10px) saturate(120%);
  }
  .auth #privacyMask{ display:none; }
  #privacyMask .mask-card{
    padding:18px 22px; border-radius:16px;
    background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.12);
    box-shadow:0 10px 30px rgba(0,0,0,.45); color:#e6f0ff; text-align:center; font-weight:700;
  }
  #privacyMask .mask-note{ opacity:.8; font-weight:500; font-size:12px; margin-top:6px; }

  /* App shell / header / card / etc. (inchangé visuel) */
  .app{ min-height:100dvh; display:grid; grid-template-rows:auto 1fr auto; }
  .header{
    position: sticky; top:0; z-index:10; padding: 16px clamp(14px,4vw,22px);
    background: linear-gradient(180deg, rgba(6,12,20,.75), rgba(6,12,20,.35), transparent),
                repeating-linear-gradient(90deg, rgba(255,255,255,.035) 0 1px, transparent 1px 3px);
    border-bottom:1px solid rgba(120,200,255,.18);
    backdrop-filter: blur(6px) saturate(120%);
  }
  .h-wrap{ max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:center; gap:12px; position:relative; }
  h1{ margin:0; font-size: clamp(18px, 2.2vw, 26px); letter-spacing:.3px; text-shadow:0 0 18px rgba(30,200,255,.35) }
  .container{ width:100%; max-width:min(1100px, 94vw); margin:0 auto; padding: 14px clamp(14px,4vw,22px) 90px; }
  .card{
    position:relative; overflow:hidden; border-radius: var(--radius);
    background: linear-gradient(180deg, var(--panel-1), var(--panel-2));
    border:1px solid var(--border-outer); box-shadow: var(--shadow-lg); padding:16px;
  }
  .noise{ position:absolute; inset:0; pointer-events:none; border-radius:inherit; opacity:.08; mix-blend-mode: overlay; }

  .support-title{ text-align:center; font-weight:800; font-size:clamp(16px, 1.8vw, 20px); margin:4px 0 14px; color:#eaf4ff; letter-spacing:.6px; text-shadow: 0 0 6px rgba(0, 180, 255, .4); }
  .week-label{ text-align:center; font-weight:400; font-size:clamp(12px, 1.2vw, 14px); font-style:italic; margin:0 0 10px; color:var(--muted-strong); }

  .member-ro{
    display:grid; grid-template-columns: 1fr auto auto; gap:8px;
    border:1px solid rgba(120,200,255,.28); border-radius:12px; padding:10px;
    background: linear-gradient(180deg, rgba(16,28,44,.58), rgba(10,22,36,.62));
    box-shadow: var(--shadow-sm); align-items:center; margin-bottom:8px;
  }
  .member-ro .tag{ font-weight:900; letter-spacing:.2px; }
  .member-ro .role{ color:var(--muted-strong); font-size:clamp(12px, 1.2vw, 13px) }
  .tickets-badge{
    min-width:56px; text-align:center; font-weight:900; border-radius:999px; padding:6px 10px;
    background:linear-gradient(90deg, #e7f5ff, #cfe9ff, #e7f5ff); color:#0c1a2a; border:1px solid rgba(120,200,255,.45);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.7); background-size:200% 100%; animation: badgeGlow 3.2s linear infinite;
  }
  @keyframes badgeGlow{ 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
  .status.ok{ color:#24e3b5; } .status.low{ color:#ff9c9c; } .status.neutral{ color:#8eb5cf; }

  .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 16px; border-radius:999px; border:0; cursor:pointer; font-weight:800; line-height:1; color:#03121a; background: linear-gradient(180deg, #b9efff, #59d4ff); box-shadow: inset 0 1px 0 rgba(255,255,255,.65), var(--shadow-sm); }
  .btn.gray{ background:#2b3446; color:#eaf4ff; box-shadow: inset 0 0 0 1px rgba(255,255,255,.14), var(--shadow-sm); }
  .btn.small{ padding:8px 12px; font-size:13px }
  a.btn{ text-decoration:none; }

  /* (6) Boutons d’auth: login visible seulement en non-admin, logout visible seulement en admin */
  .auth #loginBtn{ display:none !important; }
  .noadmin #logoutBtn{ display:none !important; }
  #logoutBtn{ position: fixed; top: 10px; right: 10px; z-index: 10000; }

  /* (7) Badge d’état discret */
  #stateBadge{
    position:fixed; left:10px; top:10px; z-index:10000;
    padding:6px 10px; border-radius:999px; font-size:12px; font-weight:800;
    background:rgba(10,20,34,.72); border:1px solid rgba(120,200,255,.28); color:#cfe9ff;
    backdrop-filter: blur(8px) saturate(120%);
  }
  </style>
</head>
<body>
  <!-- (5) Masque flou (message seul) -->
  <div id="privacyMask" aria-hidden="true">
    <div class="mask-card">
      🔒 Contenu verrouillé — connecte-toi (Admin) pour charger les données
      <div class="mask-note">Aucune donnée n’est chargée tant que tu n’es pas authentifié(e).</div>
    </div>
  </div>

  <!-- (7) Badge d’état -->
  <div id="stateBadge" role="status" aria-live="polite">Lecture seule</div>

  <!-- (6) Boutons d’auth -->
  <div id="authCtas" style="position:fixed; right:10px; bottom:10px; z-index:10000; display:flex; gap:8px;">
    <button id="loginBtn"  class="btn small">Se connecter (Admin/Google)</button>
    <button id="logoutBtn" class="btn gray small">Déconnexion</button>
  </div>

  <div class="app app-content"><!-- (1) floutée en noadmin -->
    <header class="header">
      <div class="h-wrap">
        <h1>Tableau de support — Neon Glass PRO</h1>
      </div>
    </header>

    <main class="container">
      <section id="baseCard" class="card">
        <div id="captureArea" aria-live="polite">
          <div class="support-title">Support — Tickets</div>
          <div id="weekLabel" class="week-label">Semaine du … au …</div>
          <div class="noise"></div>
          <div id="roList">
            <!-- (2) Placeholders neutres tant que non-auth -->
            <div class="member-ro">
              <div><div class="tag">—</div><div class="role">—</div></div>
              <div class="tickets-badge">0</div>
              <div class="status neutral">—</div>
            </div>
          </div>
        </div>

        <div class="actions" style="margin-top:10px; display:flex; justify-content:flex-end; gap:8px;">
          <button class="btn gray" id="refreshBtn" title="Actualiser depuis Firestore">Actualiser</button>
          <button class="btn" id="exportPngBtn">Télécharger l'image (PNG)</button>
        </div>

        <div class="lang-row" style="display:flex; justify-content:flex-end; margin-top:10px;">
          <div class="lang-switch" aria-label="Langue" style="display:flex; gap:6px; align-items:center; background: rgba(10,20,34,.5); border:1px solid rgba(120,200,255,.25); border-radius:999px; padding:4px;">
            <button id="lang-fr" type="button" class="btn gray small">FR</button>
            <button id="lang-en" type="button" class="btn gray small">EN</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- html2canvas pour export PNG -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

  <!-- App JS principal (ESM Firebase) -->
  <script type="module">
    /* ========= (3) Firestore = source unique des données sensibles ========= */
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, setPersistence, browserLocalPersistence, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // (12) Whitelist multi-emails — complète avec tes autres adresses si besoin
    const ALLOWED_EMAILS = [
      "lithiumm31@gmail.com"
    ];

    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyD0X6PY8Xwnt6GFjh4I9J2v65KBPnFPuEs",
      authDomain: "support-app-64fca.firebaseapp.com",
      projectId: "support-app-64fca",
      storageBucket: "support-app-64fca.appspot.com",
      messagingSenderId: "391759293249",
      appId: "1:391759293249:web:e06e61accd103c98a60fc0",
      measurementId: "G-PYE2M5LMNY"
    };

    const app   = getApps().length ? getApp() : initializeApp(FIREBASE_CONFIG);
    const auth  = getAuth(app);
    const db    = getFirestore(app);
    const prov  = new GoogleAuthProvider();
    prov.setCustomParameters({ prompt: 'select_account' });

    // (9) Connexion persistante
    setPersistence(auth, browserLocalPersistence).catch(()=>{});

    /* ========= State helpers ========= */
    const el = (id)=>document.getElementById(id);
    function setAdmin(on){
      try{ sessionStorage.setItem('is_admin', on ? '1':'0'); }catch(e){}
      document.documentElement.classList.toggle('auth', !!on);
      document.documentElement.classList.toggle('noadmin', !on);
      el('stateBadge').textContent = on ? 'Admin connecté' : 'Lecture seule';
    }
    function purgeLocal(){ // (4) purge locale au logout
      try{ sessionStorage.clear(); }catch(e){}
      try{ localStorage.clear(); }catch(e){}
    }

    /* ========= (3) API: loadData/saveData (Firestore only) ========= */
    async function loadData(){
      // Lecture minimaliste: links, members, tickets
      // Tous sensibles → lus uniquement en admin
      const linksDoc = await getDoc(doc(db, "links", "config")).catch(()=>null);
      const membersQ = await getDocs(collection(db, "members")).catch(()=>null);
      const ticketsQ = await getDocs(collection(db, "tickets")).catch(()=>null);

      const LINKS = linksDoc?.exists() ? linksDoc.data() : {};
      const members = membersQ ? membersQ.docs.map(d=>({ id:d.id, ...d.data() })) : [];
      const tickets = {};
      if(ticketsQ){ ticketsQ.forEach(d=> tickets[d.id] = (d.data()?.count)||0 ); }

      renderReadOnly(members, tickets);
      return { LINKS, members, tickets };
    }

    async function saveData(path, data){
      // Ecriture générique (admin uniquement)
      // path {type:'links'|'tickets', id?:string}
      if(path.type === 'links'){
        await setDoc(doc(db, "links", "config"), data, { merge:true });
      }else if(path.type === 'tickets' && path.id){
        await setDoc(doc(db, "tickets", path.id), { count: Number(data.count||0) }, { merge:true });
      }
      // on pourrait rajouter: members add/update/delete ici (selon tes actions UI)
    }

    /* ========= UI: rendu (placeholders par défaut) ========= */
    function computeStatus(tag, n){
      if(n>=7) return {text:'✅', cls:'ok'}; // règle simple par défaut
      return {text:'⚠️', cls:'low'};
    }

    function renderReadOnly(members=[], tickets={}){
      const box = el('roList');
      box.textContent = '';
      if(!Array.isArray(members) || members.length===0){
        // Placeholders si rien / non-admin ou pas encore chargé
        const row = document.createElement('div');
        row.className = 'member-ro';
        row.innerHTML = `
          <div><div class="tag">—</div><div class="role">—</div></div>
          <div class="tickets-badge">0</div><div class="status neutral">—</div>`;
        box.appendChild(row);
        return;
      }
      members.forEach(m=>{
        const n = Number((tickets[m.tag] ?? 0) || 0);
        const s = computeStatus(m.tag, n);
        const row = document.createElement('div');
        row.className = 'member-ro';
        // pas d’innerHTML avec externe; ici on contrôle les champs (tag/role/langs) → texte
        const left = document.createElement('div');
        const tag = document.createElement('div'); tag.className='tag'; tag.textContent = m.tag||'—';
        const role= document.createElement('div'); role.className='role'; role.textContent = [m.role, m.langs].filter(Boolean).join(' — ') || '—';
        left.appendChild(tag); left.appendChild(role);

        const badge = document.createElement('div'); badge.className='tickets-badge'; badge.textContent = isNaN(n)?'0':String(n);
        const st = document.createElement('div'); st.className='status ' + (s.cls||'neutral'); st.textContent = s.text||'—';

        row.appendChild(left); row.appendChild(badge); row.appendChild(st);
        box.appendChild(row);
      });
    }

    /* ========= Auth UI ========= */
    function wireAuthButtons(){
      const login  = el('loginBtn');
      const logout = el('logoutBtn');
      if(login){
        login.addEventListener('click', async ()=>{
          try{
            const res = await signInWithPopup(auth, prov);
            const email = res?.user?.email || '';
            if(ALLOWED_EMAILS.map(x=>x.toLowerCase()).includes(email.toLowerCase())){
              setAdmin(true);
              await loadData(); // (3) charger après login
            }else{
              alert('Compte non autorisé: ' + (email||'inconnu'));
              await signOut(auth);
              setAdmin(false);
            }
          }catch(e){
            console.error(e);
            alert('Connexion Google échouée.');
            setAdmin(false);
          }
        });
      }
      if(logout){
        logout.addEventListener('click', async ()=>{
          try{ await signOut(auth); }catch(e){}
          purgeLocal();          // (4) purge totale
          setAdmin(false);       // retour état lecture seule
          renderReadOnly([],{}); // placeholders
        });
      }
    }

    /* ========= Etat initial (8: verrou par défaut) + (6) badge/ctas ========= */
    (function initLock(){
      const isAdmin = sessionStorage.getItem('is_admin') === '1';
      setAdmin(!!isAdmin);
      wireAuthButtons();
      // Pas de chargement de données tant qu’on n’est pas admin
      if(isAdmin){ loadData().catch(()=>{}); }
    })();

    /* ========= Confort/robustesse (10, 13 partiels NOW scope) ========= */
    // Mini notifier (toasts light)
    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      Object.assign(t.style, {
        position:'fixed', left:'50%', transform:'translateX(-50%)',
        bottom:'80px', background:'rgba(0,0,0,.7)', color:'#fff',
        padding:'8px 12px', borderRadius:'10px', zIndex:10001, fontWeight:'700'
      });
      document.body.appendChild(t);
      setTimeout(()=>{ t.remove(); }, 1400);
    }

    // Export PNG (inchangé, robustifié)
    import "https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js";
    el('exportPngBtn')?.addEventListener('click', async ()=>{
      const cap = el('captureArea');
      if(!cap) return;
      let bg = getComputedStyle(document.body).backgroundColor || '#0b1728';
      if(!bg || bg==='transparent' || bg==='rgba(0, 0, 0, 0)') bg='#0b1728';
      const canvas = await html2canvas(cap, { backgroundColor:bg, scale: Math.max(1, window.devicePixelRatio||1) }).catch(()=>null);
      if(!canvas){ alert("Impossible de générer l'image sur ce navigateur."); return; }
      if(canvas.toBlob){
        canvas.toBlob((blob)=>{
          const a = document.createElement('a');
          a.download = 'support_table.png';
          a.href = URL.createObjectURL(blob);
          document.body.appendChild(a); a.click();
          setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 800);
        }, 'image/png');
      }else{
        const a = document.createElement('a');
        a.download='support_table.png';
        a.href = canvas.toDataURL('image/png');
        document.body.appendChild(a); a.click();
        setTimeout(()=>a.remove(), 800);
      }
      toast('Export PNG ✓');
    });

    // (13) Bouton “Actualiser les données” (admin)
    el('refreshBtn')?.addEventListener('click', async ()=>{
      if(sessionStorage.getItem('is_admin')==='1'){
        await loadData().catch(()=>{ toast('Erreur ×'); });
        toast('Actualisé ✓');
      }else{
        toast('Lecture seule');
      }
    });

    // Lang (squelette i18n)
    el('lang-fr')?.addEventListener('click', ()=>{ document.documentElement.lang='fr'; toast('FR'); });
    el('lang-en')?.addEventListener('click', ()=>{ document.documentElement.lang='en'; toast('EN'); });

  </script>
</body>
</html>
